[toc]



## abstract

存放`nginx`配置文件和配置文件管理脚本

起初使用的是原版nginx,后来为了满足更复杂的需求,引入openresty(功能增强版nginx),来实现动态处理,尤其是实现js挑战的反爬和防御功能.

针对原版nginx(后续简称为nginx)编写的配置在openresty上都可以直接使用,反之,为openresty编写的配置不能在原版使用.

这里还有一份单独的文档:`js_challenge_signed.md`,里面描述的更加细节也比较技术性,这里简单说明.

js挑战的正式版配置(`js_challenge`)出来之前,有过简化版或者设计简陋的版本:

- `com_js_naive.conf`这个版本支持nginx(原版),但是cookie容易被提取和盗用,没有额外的html文件美化js挑战页面,但是内容简单易懂,兼容性强.仍然有一定的防御作用和使用价值.
- `com_js_plus.conf`这个也是基于原版nginx做的,不过增加了专门的挑战页面过渡更自然,看起来更加美观,但是受限于原版nginx的功能,和上面最初版本有类似的问题.
- `com_js_signed_fake.conf`,是引入openresty的雏形版本,相比于上面的版本,在cookie防盗用方面有所增强,但是有设计缺陷,cookie的获取没有强制浏览器(其他非浏览器客户端第一次请求会被要求验证,但是仍然分发cookie,如果客户端请求时保存cookie并在第二次请求时携带,则仍然可以请求成功)
- `com_js_signed.conf`,修复上面的非浏览器客户端能够间接访问的问题,要求客户端执行js才能获取最终有效的凭据,并考虑了主流爬虫的放行和反向校验(避免被简单的user-agent伪装成搜索引擎而轻易绕过js挑战)

## 文件说明

- 带有js字样的是为js挑战准备的,包括`.conf`和`.html`
  - `com_js_signed.conf`针对于openresty编写,原版nginx不能使用,其他`com_...conf`兼容原版nginx
- 主配置文件:
  - `nginx_nginx.conf`,适用于原版的主配置,部署时用来替换`nginx.conf`
  - `nginx_openresty.conf`

## 注意事项

- 搜索引擎的爬虫可以带来流量,因此在封锁或防御恶意爬虫时也要检测和验证google/bing爬虫能否顺利抓取页面,检验方法有许多:
  - 使用js挑战后,通常服务器负载会因为普通爬虫脚本无法爬取核心内容(数据库查询次数降低)而负载降低;但是如果负载降低过头(比如始终低于10%,那么就要怀疑是不是规则没写好,导致爬虫抓取的是挑战页面而没有访问到真正的页面(没有数据库查询)
  - 另一方面是检查日志(nginx/openresty),但是注意日志格式中要包含`$body_bytes_sent `(默认会包含的),如果爬虫没有抓取到真正的页面,那么会发现日志中的`bytes`大小很小(通常不足10kB(10000B)),并且大量请求的bytes都一样大,这就是爬虫抓取的是挑战页面的征兆

