[toc]



## abstract

è€ƒè™‘åˆ°æ–°çš„ç«™éœ€è¦è¢«ä¸»æµæœç´¢å¼•æ“çˆ¬è™«å°½å¿«çˆ¬å–æ”¶å½•,è€Œè€ç«™éœ€è¦é˜²æ­¢è¿‡å¤šçˆ¬è™«å¯¼è‡´æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜çš„ä¸¤æ–¹é¢ä¸åŒçš„éœ€è¦,è¿™é‡Œå°†ç›¸å…³çš„nginxé…ç½®åˆ†æˆä¸¤éƒ¨åˆ†.

æ–¹æ¡ˆè®¾è®¡ä»¥æ¯æ¬¡å°½å¯èƒ½å°‘æ”¹åŠ¨(æ–‡ä»¶æ•°é‡)ä¸ºç›®æ ‡,å®Œæˆä¸Šè¿°ä»»åŠ¡çš„è‡ªåŠ¨åŒ–.

- ä¸€éƒ¨åˆ†æ˜¯è€ç«™ç‚¹å’Œæ–°ç«™ç‚¹éƒ½åº”è¯¥å¼•å…¥(include)çš„å®‰å…¨æ€§é…ç½®,ä¸»è¦æ˜¯é˜²æ­¢æ•æ„Ÿæ–‡ä»¶è¢«è®¿é—®æˆ–è€…è¢«ç‰¹æ®Šè·¯å¾„è¢«çˆ†ç ´,è¿™éƒ¨åˆ†æ¯”å¦‚å–åä¸º`com.conf`
- å¦ä¸€éƒ¨åˆ†æ˜¯é™æµ,è€ç«™ç‚¹é™æµä¸¥æ ¼ä¸€äº›,å¯ä»¥ä¿æŠ¤æ•°æ®å®‰å…¨,ä¹Ÿå¯ä»¥é™ä½çˆ¬è™«å¯¹æœåŠ¡å™¨æ—©æˆçš„è¿‡å¤§è´Ÿæ‹…,éœ€è¦å¼•å…¥é™æµé…ç½®æ¯”å¦‚`limit_rate.conf`;è€Œæ–°ç«™ç‚¹åˆ™åœ¨ä¸Šçº¿1~2å‘¨å†…å¼€æ”¾çˆ¬è™«,å°‘é‡é™æµæˆ–è€…ä¸é™æµ;ç­‰1~2å‘¨ä¹‹åå¼•å…¥ä¸¥æ ¼çš„é™æµé…ç½®æ–‡ä»¶

ç°åœ¨é—®é¢˜åœ¨äºæ–°ç«™å˜æˆè€ç«™è¿™ä¸ªè¿‡ç¨‹å¦‚ä½•æ£€æµ‹å’Œåˆ¤å®š,å¹¶ä¸”åˆ¤å®šä¹‹åä½¿ç”¨æ‰§è¡Œä»€ä¹ˆåŠ¨ä½œ(è„šæœ¬)

bashå’Œpythonè„šæœ¬å‡å¯å®ç°æ­¤ä»»åŠ¡,ä¸è¿‡è€ƒè™‘åˆ°ä»»åŠ¡å…·æœ‰ä¸€å®šçš„å¤æ‚åº¦,å°¤å…¶æ˜¯æ—¥æœŸæ—¶é—´è®¡ç®—,ä½¿ç”¨pythoné—¨æ§›ä¼šæ¯”è¾ƒä½.

### å±€é™æ€§

åˆ†æ‰¹é™æµè‡ªåŠ¨è°ƒæ•´ä½œç”¨å¯èƒ½æ²¡æœ‰æƒ³è±¡ä¸­çš„å¤§,ä¸»è¦ä½œç”¨äºæ–°ç½‘ç«™åˆšå»ºç«™çš„ä¸€æ®µæ—¶æœŸæ–¹ä¾¿googleçˆ¬è™«,æ›´åŠ ä¸¥æ ¼çš„é™æµæ–¹æ¡ˆéœ€è¦å…¶ä»–æ‰‹æ®µ:

- å€ŸåŠ©cloudflare:
  - `$http_cf_ipcountry `å­—æ®µåˆ¤æ–­è®¿å®¢ipæ¥æº,ä»…å…è®¸ç‰¹å®šå›½å®¶ipæˆ–è€…å…¶ä»–ipå±æ€§(ä½å®…ip)è®¿é—®(å­˜åœ¨å‰¯ä½œç”¨,å¯èƒ½å½±å“æœç´¢å¼•èµ·çˆ¬è™«å’Œä¸€äº›æ½œåœ¨å®¢æˆ·)
  - å¯¹æ¥`fail2ban`,é™åˆ¶æŸäº›ç±»å‹çš„è¯·æ±‚,ä¾‹å¦‚å¯¹æ¶æ„éªšæ‰°è®¿é—®(çŠ¶æ€ç 499æˆ–404)çš„ipå¯ç”¨è´¨è¯¢(äººæœºéªŒè¯)ç”šè‡³ipå°é”;fail2banæœ¬èº«ä¸ä¾èµ–äºcloudflare,ä½†æ˜¯å¦‚æœæ‰€æœ‰ç½‘ç«™éƒ½èµ°cfä»£ç†,å°±éœ€è¦å¯¹æ¥cfçš„apiåœ¨cdnå±‚é¢è®¾ç½®å°é”æˆ–è´¨è¯¢

### æœ¬æ–‡æ¶‰åŠè„šæœ¬

```powershell
$sh\nginx_conf

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a---          2025/12/20     8:26          23753 maintain_nginx_vhosts.py
-a---          2025/12/15    11:32           2699 reload_nginx.py
-a---           2026/1/21    17:28            287 maintain_nginx_vhosts.sh
-a---           2026/1/21    17:28            972 update_cf_ip_configs.sh
-a---           2026/1/21    17:28           9673 update_nginx_vhosts_conf.sh
-a---           2026/1/21    17:28           4605 update_nginx_vhosts_log_format.sh
```

ä¸»è¦ä»‹ç»`maintain_nginx_vhost`ç›¸å…³çš„`.py`,`.sh`,åè€…æ˜¯å¯¹å‰è€…çš„ä¸€ä¸ªåŒ…è£…,é€‚åˆä½œä¸ºå®šæ—¶ä»»åŠ¡ä¸­çš„é…ç½®è¡Œ.è¿™æ ·å½“`.py`å¦‚æœæœ‰æ”¹åŠ¨æˆ–è€…è°ƒç”¨å‚æ•°å‘ç”Ÿæ”¹å˜,åˆ™åªéœ€è¦ä¿®æ”¹`.sh`æ–‡ä»¶.

å…¶ä½™è„šæœ¬éƒ½æ˜¯`.sh`:

nginx(vhost)é…ç½®æ–‡ä»¶ä¿®æ”¹è„šæœ¬,é€šè¿‡`-h`è·å–ä½¿ç”¨å¸®åŠ©.

- `update_nginx_vhosts_conf.sh`ç”¨æ¥æ‰‹åŠ¨æ›´æ–°é…ç½®æ–‡ä»¶,å¯ä»¥æŒ‡å®šæ—¶é—´èŒƒå›´ç­‰å‚æ•°
- `update_nginx_vhosts_log_format.sh`ç”¨æ¥æ‰¹é‡ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„æ—¥å¿—æ ¼å¼(`access_log`æŒ‡ä»¤)

å…¶ä»–

- `update_cf_ip_configs.sh`ç”¨æ¥æ‹‰å–cloudflareçš„ip,åšå®‰å…¨cdnæ£€æŸ¥,è·å–çš„è®¿å®¢ip(è™½ç„¶ä¹Ÿå¯èƒ½æ˜¯ä»£ç†ip),è¾ƒæ–°ç‰ˆæœ¬çš„å®å¡”ä¹Ÿæä¾›äº†ç±»ä¼¼åŠŸèƒ½è§£ææºip

## åˆ†æ‰¹é™æµåˆ†æ

### ç¡®å®šç½‘ç«™çš„åˆ›å»ºæ—¶é—´

å…³é”®æ˜¯ä½¿ç”¨å¯é çš„æ–¹å¼åˆ¤æ–­ä¸€ä¸ªç«™å¤§æ¦‚åˆ›å»ºåœ¨ä»€ä¹ˆæ—¶å€™,è¿™æ ·å…¶ä»–è®¡ç®—å’Œå·¥ä½œå°±å¯ä»¥å±•å¼€

ç½‘ç«™åˆ›å»ºæ—¶é—´ä¸éœ€è¦å¾ˆç²¾å‡†,è¯¯å·®åœ¨1ä¸ªå°æ—¶ç”šè‡³24å°æ—¶éƒ½æ²¡å…³ç³»,å› æ­¤,åªè¦èƒ½å¤Ÿè®°å½•ç½‘ç«™åˆ›å»ºçš„æ—¥å¿—(å¹´æœˆæ—¥)å³å¯(æ—¶åˆ†ç§’ä¸æ˜¯å¿…é¡»çš„)

ç¡®å®šç½‘ç«™åˆ›å»ºæ—¥æœŸçš„åŸºæœ¬æ–¹æ¡ˆæœ‰2ç§:

- æ¯æ¬¡åˆ›å»ºç½‘ç«™çš„æ—¶å€™,é¡ºä¾¿ç»´æŠ¤ä¸€ä¸ª**å»ºç«™æ—¥æœŸè¡¨**,æ¯”å¦‚ä½¿ç”¨ä¸€ä¸ªcsvæ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶(`SITE_BIRTH_CSV`),åŒ…å«ä¸¤ä¸ªå­—æ®µ(æˆ–å¯é€‰çš„ç¬¬ä¸‰ä¸ªå­—æ®µ):åŸŸå,åˆ›å»ºæ—¥æœŸ;(`domain,birth_time,status`)

  ```csv
  domain,birth_time,status
  domain1.com,2025-10-10 18:07:17,young
  domain2.com,2025-11-04 18:07:17,young
  ```

  å…¶ä¸­statuså¯ä»¥è®©å„ä¸ªç«™çš„çŠ¶æ€(æ–°/è€)æ›´ç›´è§‚.

- åˆ©ç”¨ç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿ,`stat`å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶çš„åˆ›å»ºæ—¥æœŸ(`birth_time`),è¿™ä¸ªæ–¹æ¡ˆå®¹æ˜“å—åˆ°ä¸€äº›æ–‡ä»¶æ“ä½œçš„å½±å“,ä»è€Œå¯é æ€§ä¸ä½³

  ```bash
  $ stat domain1.com.conf
    File: install_panel.sh
    Size: 59199           Blocks: 120        IO Block: 4096   regular file
  Device: 252,1   Inode: 185860108   Links: 1
  Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
  Access: 2025-09-27 08:35:31.104942416 +0800
  Modify: 2025-09-23 15:49:37.000000000 +0800
  Change: 2025-09-27 08:35:31.073942797 +0800
   Birth: 2025-09-27 08:35:30.890945044 +0800
  ```

  æ­¤å¤–,findå‘½ä»¤ä¸æä¾›birth_timeçš„è¿‡æ»¤é€‰é¡¹,å¦‚æœä½¿ç”¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´,åˆ™æ—¥æœŸçš„å¯é æ€§ä¼šæ›´ä½

- è¿˜å¯ä»¥åœ¨å»ºç«™çš„æ—¶å€™å‘å„ä¸ªç½‘ç«™çš„é…ç½®æ–‡ä»¶æ’å…¥ä¸€è¡Œæ³¨é‡Š(åŒ…å«å»ºç«™æ—¥æœŸ),è¿™æ ·æ¯æ¬¡ç½‘ç«™çš„å»ºç«™æ—¥æœŸè¡Œ,ä½†æ˜¯å¯é æ€§ä»ç„¶ä¸å¦‚å•ç‹¬ä¸€ä¸ªå»ºç«™æ—¥æœŸè¡¨,è¿™ä½“ç°åœ¨ç‹¬ç«‹æ€§ä¸Š

  ```nginx
      #CUSTOM-CONFIG-START(2025-10-10 18:07:17)
      include /www/server/nginx/conf/com.conf;
  	include /www/server/nginx/conf/limit_rate.conf;
      #CUSTOM-CONFIG-END
  ```


### é€‰æ‹©csvè®°å½•å»ºç«™æ—¥æœŸçš„ç†ç”±

- æ ¼å¼ç®€å•,ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªç½‘ç«™çš„ä¿¡æ¯
- å¯ä»¥å€ŸåŠ©excelç­‰è¡¨æ ¼è½¯ä»¶å¿«é€Ÿæ‰¹é‡æ‰‹åŠ¨å¡«å……æ“ä½œ,å¯è§†åŒ–æ’åºç­‰æ“ä½œ,æˆ–è€…pandasåº“æ‰¹é‡è®¡ç®—å¤„ç†
- æ–°å¢å­—æ®µç®€å•,æ¯”jsonæ›´å®¹æ˜“æ›´æ”¹

### csv å­—æ®µè¯´æ˜

ç›®å‰csvä¸­çš„è¡¨å¤´è¯´æ˜å¦‚ä¸‹

- `domain`:å–å€¼ä¸ºå­—ç¬¦ä¸²,é€šå¸¸ä¸º`domain.com`æ ¼å¼,ä¹Ÿå…¼å®¹ä¸€èˆ¬çš„åŒ…å«åŸŸåçš„`url`,æ­¤å­—æ®µä¸ºç©ºçš„è¡Œä¼šè¢«è·³è¿‡å¤„ç†
- `birth_time`:æ—¥æœŸ(æ—¶é—´),æ¯”è¾ƒçµæ´»,å…¸å‹æ ¼å¼ä¸º`yyyy-MM-dd hh:mm:ss`æˆ–è€…æ›´ç²¾ç¡®,ä¹Ÿå¯ä»¥æ›´ç®€åŒ–`yyyy/MM/dd`

è¾…åŠ©å­—æ®µ

- `status`:å–å€¼ä¸º`young`æˆ–`old`,ä¸ªåˆ«æƒ…å†µå¯ä»¥æ”¾ç©º
- `update_time`:åŒ`birth_time`ä¸ºæ—¶é—´,ä½†æ˜¯ä¸€èˆ¬ä¸è¦è‡ªå·±å¡«å†™(æ²¡æœ‰æ„ä¹‰),ç¨‹åºè‡ªåŠ¨ç»´æŠ¤æ›´æ–°æ—¥æœŸ

## åˆ†æ‰¹é™æµç®¡ç†æ–¹æ¡ˆ

æ¯æ¬¡å»ºç«™,æˆ‘ä»¬éƒ½é»˜è®¤ä¸ºæ–°ç«™çš„é…ç½®æ–‡ä»¶(vhost)ä¸­çš„`.conf`æ’å…¥é»˜è®¤ä¸¥æ ¼çš„é…ç½®:`com.conf`ä»¥åŠå…¶ä»–é™æµç›¸å…³çš„é…ç½®(æ¯”å¦‚`limits.conf`)

æ— è®ºæ˜¯ä»€ä¹ˆè¯­å¥å—,è‡ªå®šä¹‰çš„å¼•å…¥è¯­å¥å—æ€»æ˜¯çº¦å®šä»¥"`#CUSTOM-CONFIG-START`"å¼€å¤´,å¹¶ä»¥"`#CUSTOM-CONFIG-END`"ç»“æŸ,æ–¹ä¾¿å®šä½

æˆ‘ä»¬ç®€ç§°è¿™ç§å¼•å…¥è¯­å¥å—ä¸º"**è‡ªå®šä¹‰è¯­å¥å—**",å¹¶ä¸”æ€»æ˜¯å°†è‡ªå®šä¹‰è¯­å¥å—æ’å…¥åˆ°æ ‡è®°`"#CERT-APPLY-CHECK--START"`å‰é¢

---



```nginx
server
{
    listen 80;
    server_name domain1.com www.domain1.com *.domain1.com;
    index index.php index.html index.htm default.php default.htm default.html;
    root /www/wwwroot/cjq/domain1.com/wordpress;
...æ’å…¥è‡ªå®šä¹‰å—
    #CUSTOM-CONFIG-START
    include /www/server/nginx/conf/com.conf;
	include /www/server/nginx/conf/limit_rate.conf;
    #CUSTOM-CONFIG-END
    
....å…¶ä½™å†…å®¹
    #CERT-APPLY-CHECK--START
```

---



ç°åœ¨,æˆ‘ä»¬ä»¥å»ºç«™æ—¥æœŸè¡¨çš„æ–¹æ¡ˆä¸ºä¾‹.

æ‰«æè¡¨æ ¼ä¸­è·æ‰«æåŠ¨ä½œå‘ç”Ÿæ—¶è¾¾åˆ°æŒ‡å®šæ—¶é•¿`DAYS`(æ¯”å¦‚14å¤©)çš„è®°å½•(è·å–å¯¹åº”çš„åŸŸååˆ—è¡¨,è¿™æ„å‘³ç€å°†è¦è¢«æ£€æŸ¥å’Œæ“ä½œçš„ç½‘ç«™é…ç½®æ–‡ä»¶æ•°é‡æ§åˆ¶åœ¨è¾ƒæ–°çš„ç«™ä¸­,è€ç«™é…ç½®æ–‡ä»¶ä¸ç”¨å¤„ç†,é™¤éæœ‰å†å²é—ç•™ç«™ç‚¹éœ€è¦é¢å¤–å¤„ç†)

ç„¶å,å°†æ’å…¥çš„å¯¼å…¥è¯­å¥ä¿®æ”¹ä¸ºä»…åŒ…å«åŸºç¡€å…¬ç”¨é…ç½®`com.conf`

> ä¸€ç§ç®€å•çš„æ–¹æ¡ˆæ˜¯ç›´æ¥æŠŠåŸæ¥æ’å…¥çš„è‡ªå®šä¹‰è¯­å¥å—æ•´ä¸ªæ›¿æ¢ä¸ºæ–°çš„è¯­å¥å—,å½“ç„¶,ç›´æ¥å°†ä¸éœ€è¦çš„å¯¼å…¥è¯­å¥æ›¿æ¢ä¸ºç©ºä¹Ÿæ˜¯å¯ä»¥çš„

- å¦‚æœæ˜¯2å‘¨å†…çš„(è§†ä¸ºæ–°ç«™),åˆ™ä¸å¯¹å…¶æ’å…¥é™æµé…ç½®,ä»…æ£€æŸ¥å…¶æ˜¯å¦å¼•å…¥äº†é€šç”¨å®‰å…¨é…ç½®

- å¯é€‰æ“ä½œ:å¦‚æœæ˜¯2å‘¨ä»¥ä¸Š(è§†ä¸ºè€ç«™),åˆ™ä¸ºå…¶æ£€æŸ¥æ˜¯å¦å®Œæ•´å®Œæ•´å¼•ç”¨äº†é€šç”¨å®‰å…¨é…ç½®å’Œä¸¥æ ¼é™æµé…ç½®,å¦‚æœæ²¡æœ‰,åˆ™ä¸ºå…¶å¼•å…¥(å†å²é—ç•™ç«™ç‚¹)

### è‡ªå®šä¹‰nginxé…ç½®æ–‡ä»¶çš„å¼•å…¥è¯­å¥å—ğŸˆ

ä¿®æ”¹`/www/server/panel/vhost/nginx `ç›®å½•ä¸‹çš„å„ä¸ªç½‘ç«™çš„é…ç½®æ–‡ä»¶`.conf`

é€šç”¨å®‰å…¨é…ç½®çš„å¼•å…¥è¯­å¥(è®°ä¸ºå—A)

```nginx
    #CUSTOM-CONFIG-START
    include /www/server/nginx/conf/com.conf;
    #CUSTOM-CONFIG-END
```

ä¸¥æ ¼é™æµé…ç½®çš„å¼•å…¥è¯­å¥(è®°ä¸ºå—B)

```nginx
    #CUSTOM-CONFIG-START
    include /www/server/nginx/conf/com.conf;
	include /www/server/nginx/conf/limit_rate.conf;
    #CUSTOM-CONFIG-END
```



### åŸºæœ¬æ€è·¯

- æ£€æŸ¥è‡ªå®šä¹‰é…ç½®æ ‡è®°`"#CUSTOM"`,å¦‚æœæœ‰,åˆ™è¯´æ˜ä¹‹å‰æ’å…¥è¿‡ç›¸å…³è‡ªå®šä¹‰é…ç½®(é€šå¸¸æ˜¯`com.conf`),ä¾‹å¦‚Aæˆ–B;
  - æ ¹æ®é…ç½®æ–‡ä»¶çš„æœ€åæ”¹åŠ¨æ—¶é—´ä¸2å‘¨æ¯”è¾ƒ,ä»è€Œå†³å®šå°†æ ‡è®°çš„è‡ªå®šä¹‰è¯­å¥å—æ›¿æ¢ä¸ºAå—æˆ–è€…Bå—ä¸­çš„1ä¸ª,æ¯”å¦‚ç§»é™¤ç°æœ‰å—,ç„¶åè¦†ç›–æ–°å—
- å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°"`#CUSTOM`"æ ‡è®°,åˆ™è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ–°å»ºçš„ç«™ç‚¹,ä¸ºå…¶æ’å…¥è¯­å¥å—Aå³å¯

æœ€å,å°†ç¼–å†™å¥½çš„å¤„ç†è„šæœ¬ä¿å­˜ä¸ºè„šæœ¬æ–‡ä»¶

å®šæœŸè¿è¡Œæ­¤è„šæœ¬æ£€æŸ¥å„ä¸ªç½‘ç«™çš„é…ç½®æ–‡ä»¶,æ‰§è¡Œæ°å½“çš„ç»´æŠ¤

### è„šæœ¬çš„ä½¿ç”¨

ç»è¿‡ä¸Šè¿°è®¨è®º,æœ¬æ–‡å®ç°çš„è„šæœ¬åŸºäºpythonæ“ä½œcsv,å®ç°çš„ä¸€å¥—åŠŸèƒ½ç›¸å¯¹å®Œå–„çš„è„šæœ¬

å¤§è‡´çš„ç”¨æ³•å¦‚ä¸‹(ä»¥å®é™…çš„è„šæœ¬å¸®åŠ©è¾“å‡ºä¸ºå‡†,è¿™é‡Œä»…ä¾›å‚è€ƒ)

è„šæœ¬å®ç°ä¸¤ä¸ªæ–¹é¢çš„åŠŸèƒ½,ä¸€ä¸ªæ˜¯ç»´æŠ¤ä¸€ä¸ªå¯é çš„csv(å»ºç«™æ—¥æœŸè¡¨),å¦ä¸€æ–¹é¢å®ç°åŸºäºè¯¥csvæ ¼å¼é…å¥—çš„è¯»å–è®¡ç®—æ“ä½œ,å¹¶æ ¹æ®è®¡ç®—ç»“æœæ›´æ–°éœ€è¦æ›´æ–°çš„nginxç«™ç‚¹é…ç½®æ–‡ä»¶,å¹¶å¯é€‰çš„æ›´æ–°csvçš„statusç­‰æ›´æ–°æ—¥æœŸ

> å¯¹äºupdateæ¨¡å¼,æä¾›äº†é¢„è§ˆé€‰é¡¹,å¯ä»¥åœ¨æ­£å¼æ›´æ–°ç½‘ç«™é…ç½®æ–‡ä»¶å‰çœ‹ä¸‹å“ªäº›ç½‘ç«™é…ç½®å°†å‘ç”Ÿå˜åŒ–

```bash
#âš¡ï¸[Administrator@CXXUDESK][~\Desktop\woo_df\sh][22:27:19] PS >
 py .\nginx_conf\maintain_nginx_vhosts.py -h
usage: maintain_nginx_vhosts.py [-h] {maintain,update} ...

nginxç«™ç‚¹é…ç½®æ‰¹é‡ç®¡ç†å·¥å…·: ç»´æŠ¤æ—¥å¿—æˆ–æ‰¹é‡æ›´æ–°nginxè™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ã€‚

positional arguments:
  {maintain,update}
    maintain         ç»´æŠ¤ç«™ç‚¹åˆ›å»ºæ—¥å¿—æ–‡ä»¶(site_birth.csv)
    update           æ‰¹é‡æ›´æ–°nginxè™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ä¸ºæ–°ç«™/è€ç«™æ¨¡å¼ï¼Œå¹¶å¯åŒæ­¥æ›´æ–°å»ºç«™æ—¥æœŸè¡¨çŠ¶æ€ã€‚

options:
  -h, --help         show this help message and exit
```

#### maintainå‘½ä»¤

```bash
#( 12/13/25@10:35PM )( root@s3 ):/www/sh/nginx_conf@mainâœ—âœ—âœ—
   py ./maintain_nginx_vhosts.py maintain -h
usage: maintain_nginx_vhosts.py maintain [-h] [-d] [-k {first,last}]

options:
  -h, --help            show this help message and exit
  -d, --drop-duplicate  åˆ é™¤é‡å¤é¡¹(é»˜è®¤ä¿ç•™ç¬¬ä¸€ä¸ª)
  -k {first,last}, --keep {first,last}
                        ä¿ç•™é‡å¤é¡¹ä¸­çš„å“ªä¸€ä¸ª(é»˜è®¤first)
                        

```

å…¸å‹ç”¨ä¾‹:

```bash
python3 /www/sh/nginx_conf/maintain_nginx_vhosts.py maintain -d -k first
```



#### updateå‘½ä»¤

ä¸»è¦æ˜¯ç»™å®šæ—¶ä»»åŠ¡è¿è¡Œçš„.

```bash
#( 12/13/25@10:20PM )( root@s3 ):/www/sh/nginx_conf@mainâœ—âœ—âœ—
   py ./maintain_nginx_vhosts.py update -h     
usage: maintain_nginx_vhosts.py update [-h] [-m {old,young}] [-q] [-n] [-a] [-d DAYS] [--dry-run]

options:
  -h, --help            show this help message and exit
  -m {old,young}, --mode {old,young}
                        ç›®æ ‡æ¨¡å¼: old(è€ç«™) æˆ– young(æ–°ç«™)ï¼Œé»˜è®¤old
  -q, --only-status-changed
                        ä»…å½“è®¡ç®—å‡ºæ¥çš„çŠ¶æ€å’ŒåŸæ—¥å¿—ä¸­çš„çŠ¶æ€ä¸ä¸€è‡´æ—¶æ‰å¤„ç†
  -n, --no-update-log   ä¸æ›´æ–°å»ºç«™æ—¥æœŸè¡¨(status/update_time)
  -a, --all-sites       å¯¹æ‰€æœ‰ç«™ç‚¹å¼ºåˆ¶åˆ‡æ¢åˆ°ç›®æ ‡æ¨¡å¼(ä¸åŒºåˆ†å½“å‰çŠ¶æ€)
  -d DAYS, --days DAYS  æ–°è€ç«™å¤©æ•°é˜ˆå€¼(é»˜è®¤14å¤©)
  --dry-run             ä»…æ‰“å°å°†è¢«å¤„ç†çš„ç«™ç‚¹å’Œé…ç½®æ–‡ä»¶,ä¸åšå®é™…ä¿®æ”¹
```

### ç”¨é€”

#### ä¸»è¦ç”¨é€”

ä¸»è¦ç”¨æ¥è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨ä¸Šå“ªäº›ç«™ç‚¹éšç€æ—¶é—´çš„æ¨ç§»ä»æ–°ç«™å˜æˆè€ç«™,å¹¶å°†è¿™äº›ä¸åœ¨æ–°(ä¸åœ¨å¹´è½»)çš„ç«™é…ç½®æ¨¡å¼æ›´æ”¹åˆ°è€ç«™æ¨¡å¼

å…³é”®éƒ¨åˆ†åœ¨äºå®šæœŸæ‰«æå»ºç«™æ—¥æœŸè¡¨(csv),æ ¹æ®æ‰«æç»“æœè®¡ç®—éœ€è¦æ›´æ–°é…ç½®çš„ç«™ç‚¹é…ç½®æ–‡ä»¶,å°†è®¡ç®—å‡ºæ¥çš„è€ç«™(å°¤å…¶æ˜¯ä»æ–°ç«™å·²ç»å˜æˆè€ç«™çš„è¿™éƒ¨åˆ†)é…ç½®æ–‡ä»¶æ£€æŸ¥å¹¶æ›´æ–°.

> è¿™é‡Œå®ç°äº†ä¸€ä¸ªå¿«é€Ÿæ¨¡å¼,å€ŸåŠ©äºcsvä¸­çš„statuså­—æ®µçš„çŠ¶æ€,å¦‚æœå·²ç»æ˜¯old,å°±ä¸éœ€è¦å¤„ç†äº†,é’ˆå¯¹æ€§æ›´å¼º(é»˜è®¤ä¹‹å‰çš„å¤„ç†éƒ½æ˜¯å¯é çš„,å·²ç»éƒ½å°†é…ç½®æ›´æ”¹ä¸ºè€ç«™æ¨¡å¼é…ç½®)

æ¯æ¬¡æ–°å»ºä¸€æ‰¹ç«™ç‚¹æ—¶,éƒ½åº”è¯¥ç»è¯¥æ‰¹æ¬¡çš„ç½‘ç«™(åŸŸå)åˆ—è¡¨æ–‡ä»¶(site_table.conf)ä¸Šä¼ åˆ°æœåŠ¡æŒ‡å®šä½ç½®(å»ºè®®ç»Ÿä¸€ä½ç½®è·¯å¾„`/www/site_table.conf`)

ç„¶åè°ƒç”¨`maintain_nginx_vhosts.py`çš„ `maintain`å­å‘½ä»¤æ›´æ–°(ç»´æŠ¤)è¯¥æœåŠ¡å™¨ä¸“å±çš„**å»ºç«™æ—¥æœŸè¡¨**(csv)

è¿™æ ·æœåŠ¡å™¨å®šæœŸè°ƒç”¨`maintain_nginx_vhosts.py`çš„`update`å­å‘½ä»¤æ¥æ‰«ææ­¤csvæ–‡ä»¶å¹¶åšå¿…è¦çš„é…ç½®æ–‡ä»¶ä¿®æ”¹

> æ³¨æ„,æ¯æ¬¡ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶éƒ½è¦åŠæ—¶é‡è½½nginxé…ç½®,ä½¿å…¶ç”Ÿæ•ˆ.
>
> ```bash
> nginx -t && nginx -s reload
> ```
>

#### é™„åŠ ç”¨é€”

è€ƒè™‘åˆ°å†å²é—ç•™é—®é¢˜,æ¯”å¦‚å¯¹ä¸€ä¸ªè€æœåŠ¡å™¨ä¸æ˜¯æ­¤å¥—ä»£ç ,è¿™éœ€è¦æ‰‹åŠ¨å¹²é¢„æŸä¸ªç¯èŠ‚,å°†è€ç«™çš„é…ç½®ç»Ÿä¸€æ‰¹é‡æ›´æ”¹çš„éœ€è¦,è„šæœ¬æä¾›äº†ä¸€äº›é€‰é¡¹,ä¾›è¿ç§»ä½¿ç”¨.

è¿™ä¸ªéƒ¨åˆ†ä¸»è¦ä½¿ç”¨çš„`update`å­å‘½ä»¤,`maintain`å­å‘½ä»¤ä¸æ€ä¹ˆç”¨

ä¾‹å¦‚,è¦æŠŠä¹‹å‰çš„æœåŠ¡å™¨ä¸Šçš„éƒ¨åˆ†æˆ–è€…æ‰€æœ‰ç½‘ç«™(ä»excelä¸­æ‹·è´å¯¹åº”çš„ç½‘ç«™åˆ—è¡¨å³å¯,è¿˜å¯ä»¥é€‰æ‹©å°†å»ºç«™æ—¥æœŸä¸€èµ·),ç²˜è´´åˆ°csvæ–‡ä»¶ä¸­,è¿™å¯ä»¥ç”¨excelç¼–è¾‘,æˆ–è€…vscodeä¸­çš„ä¸€äº›æ’ä»¶,æ¯”å¦‚`edit csv`åƒç¼–è¾‘è¡¨æ ¼ä¸€æ ·å®¹æ˜“

ç„¶åä½¿ç”¨ç±»ä¼¼`py ./maintain_nginx_vhosts.py update -m old -a`,ä½¿ç”¨`-a`é€‰é¡¹å°†å¿½ç•¥csvä¸­çš„`domain`åˆ—å¤–çš„å…¶ä»–åˆ—,å³ä¸åŒºåˆ†æ—¥æœŸå’ŒçŠ¶æ€,å°†csvä¸­åˆ—å‡ºçš„æ‰€æœ‰ç«™é…ç½®æ›´æ”¹åˆ°modeæŒ‡å®šçš„æ¨¡å¼(æ¯”å¦‚`old`)

### å®šæ—¶è¿è¡Œ

è¿™é‡Œæä¾›ä¸¤ä¸ªæ–¹æ¡ˆ,æ¨èåŒ…è£…ä¸ºbashè„šæœ¬çš„æ–¹æ¡ˆ

#### ç›´æ¥æ·»åŠ (ä¸æ¨è)

crontabä¸­æ·»åŠ è¡Œ

> è¦åœ¨æ¯å¤© 00:00 è¿è¡Œè„šæœ¬ï¼Œ`crontab` çš„æ—¶é—´æ ¼å¼åº”ä¸º `0 0 * * *`ã€‚

```bash
0 0 * * * python /www/sh/nginx_conf/maintain_nginx_vhosts.py update -m old
```

æ­¤å¤–,`crontab` ä»»åŠ¡ä¸ä¼šç›´æ¥åœ¨ç»ˆç«¯æ˜¾ç¤ºè¾“å‡ºã€‚ä¸ºäº†æ–¹ä¾¿è°ƒè¯•å’Œæ£€æŸ¥ä»»åŠ¡æ˜¯å¦æˆåŠŸï¼Œå»ºè®®å°†è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶ï¼š

```bash
0 0 * * * { python3 /www/sh/nginx_conf/maintain_nginx_vhosts.py update -m old >> /var/log/maintain_nginx_vhosts.log 2>&1 && nginx -t && nginx -s reload ; }
```

è¿™é‡Œè¦æ³¨æ„bashçš„`{ command ; }`è¾¹ç¼˜ç©ºæ ¼ä¸èƒ½çœç•¥æˆ–åˆ é™¤

> `maintain`å­å‘½ä»¤ä¸éœ€è¦å®šæœŸè¿è¡Œ,å…¶åªéœ€è¦åœ¨æ–°ç«™åˆ›å»ºçš„æ—¶å€™è§£æåŸŸååˆ—è¡¨ç»´æŠ¤ä¸€ä¸‹csvæ–‡ä»¶å³å¯,è¿™æ˜¯`maintain`çš„è¿è¡Œæ—¶æœº.
>
> å¯è§,`maintain,update`ä¸¤ä¸ªå­å‘½ä»¤çš„ç›¸å¯¹ç‹¬ç«‹æ€§.

#### åŒ…è£…ä¸ºbashè„šæœ¬ç»‘å®šnginxé‡è½½åŠ¨ä½œ

ä¸ºä¾‹æ›´æ–¹ä¾¿ç®¡ç†,å¯ä»¥è€ƒè™‘æ–°å»ºä¸€ä¸ª`.sh`æ–‡ä»¶(æ¯”å¦‚å­˜æ”¾äº`/www/sh/nginx_conf/maintain_nginx_vhosts.sh`,ç„¶åç¼–è¾‘å†…å®¹

```bash
#! /bin/bash
# /usr/bin/python3 
python3 /www/sh/nginx_conf/maintain_nginx_vhosts.py update -m old >> /var/log/maintain_nginx_vhosts.log 2>&1
nginx -t && nginx -s reload
```

è¿™æ ·å»ç»‘å®š`maintain_nginx_vhosts.py`çš„è¿è¡Œå’Œé‡è½½nginx

è¿™æ ·crontab ä¸­ç¼–è¾‘

```conf
0 0 * * * bash /www/sh/nginx_conf/maintain_nginx_vhosts.sh
```

