[toc]



## abstract

考虑到新的站需要被主流搜索引擎爬虫尽快爬取收录,而老站需要防止过多爬虫导致服务器负载过高的两方面不同的需要,这里将相关的nginx配置分成两部分

- 一部分是老站点和新站点都应该引入(include)的安全性配置,主要是防止敏感文件被访问或者被特殊路径被爆破,这部分比如取名为`com.conf`
- 另一部分是限流,老站点限流严格一些,可以保护数据安全,也可以降低爬虫对服务器早成的过大负担,需要引入限流配置比如`limit_rate.conf`;而新站点则在上线1~2周内开放爬虫,少量限流或者不限流;等1~2周之后引入严格的限流配置文件

现在问题在于新站变成老站这个过程如何检测和判定,并且判定之后使用执行什么动作(脚本)

## 方案

在linux系统中,使用find+sed组合编写脚本可以满足我们的需要

find命令检查各个站点的专属的nginx配置文件(vhost配置)是2周之内的还是2周以上的

- 如果是2周内的(视为新站),则不对其插入限流配置,仅检查其是否引入了通用安全配置
- 如果是2周以上(视为老站),则为其检查是否完整完整引用了通用安全配置和严格限流配置,如果没有,则为其引入

### 自定义nginx配置文件的引入语句块

通用安全配置的引入语句(记为块A)

```nginx
    #CUSTOM-CONFIG-START
    include /www/server/nginx/conf/com.conf;
    #CUSTOM-CONFIG-END
```

严格限流配置的引入语句(记为块B)

```nginx
    #CUSTOM-CONFIG-START
    include /www/server/nginx/conf/com.conf;
	include /www/server/nginx/conf/limit_rate.conf;
    #CUSTOM-CONFIG-END
```

无论是什么语句块,自定义的引入语句块总是约定以"#CUSTOM-CONFIG-START"开头,并以"#CUSTOM-CONFIG-END"结束,方便定位

我们简称这种引入语句块为"自定义语句块",并且总是将自定义语句块插入到标记`"#CERT-APPLY-CHECK--START"`前面

基本思路

- 检查自定义配置标记`"#CUSTOM"`,如果有,则说明之前插入过相关自定义配置(通常是`com.conf`),例如A或B;
  - 根据配置文件的最后改动时间与2周比较,从而决定将标记的自定义语句块替换为A块或者B块中的1个,比如移除现有块,然后覆盖新块
- 如果没有检测到"#CUSTOM"标记,则认为这是一个新建的站点,为其插入语句块A即可

最后,将编写好的处理脚本保存为脚本文件

定期运行此脚本检查各个网站的配置文件,执行恰当的维护

