# /www/server/nginx/conf/com_js_signed.conf
# 更可靠的 JavaScript 挑战（签名 Cookie）
# 依赖：OpenResty 自带 lua-nginx-module
#
# 使用说明：
# 1) 在 http { } 级别（nginx.conf 内）声明共享字典：
#      lua_shared_dict sc_token_store 10m;
# 2) 提供一个长随机密钥（32+ 长度），可通过：
#      - http {} 中：env SC_SECRET;
#      - 或在 server 块里：set $sc_secret "请替换为随机密钥";
# 3) 在需要保护的 server 块 include 本文件，替换旧的 com_js_plus.conf。
#
# 核心思路：
# - 浏览器访问受保护页面时，如无有效签名 Cookie，则返回到 @challenge。
# - @challenge 用 Lua 生成短期签名 Token 写入 Cookie（绑定 UA，30 分钟过期）。
# - 普通脚本/爬虫难以重现签名；偷来的 Cookie 窗口短且与 UA 绑定，价值低。
# - 仍保留搜索引擎、社交爬虫、静态资源放行。

# ============================================
# 默认需要挑战
# ============================================
set $need_challenge 1;
set $sc_secret "JslxcHtCz7PoueF2v7h2edDY7nAQ5JKKemvnXjDzjCY=";
# ============================================
# 搜索引擎白名单（非中国主流爬虫）
# ============================================
if ($http_user_agent ~* "(Googlebot|Google-Read-Aloud|Storebot-Google)") {
    set $need_challenge 0;
}
if ($http_user_agent ~* "(Bingbot|BingPreview|msnbot|adidxbot)") {
    set $need_challenge 0;
}
if ($http_user_agent ~* "(YandexBot|DuckDuckBot|Slurp|Applebot)") {
    set $need_challenge 0;
}

# AI 爬虫白名单（按需保留）
if ($http_user_agent ~* "(GPTBot|ChatGPT|anthropic|Claude|PerplexityBot|cohere-ai|openai)") {
    set $need_challenge 0;
}

# 社交媒体爬虫
if ($http_user_agent ~* "(facebookexternalhit|Twitterbot|LinkedInBot|Pinterest|WhatsApp|TelegramBot|Discordbot)") {
    set $need_challenge 0;
}

# 支付/监控服务
if ($http_user_agent ~* "(PayPal|Stripe|Shopify|UptimeRobot|Pingdom)") {
    set $need_challenge 0;
}

# ============================================
# 静态资源跳过验证
# ============================================
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot|mp4|mp3|pdf|zip)$ {
    set $need_challenge 0;
    expires 30d;
    access_log off;
}

# ============================================
# Cookie 签名校验（sc2）
# 格式： sc2=时间戳_随机值_签名Base64
# 签名： MD5(secret|ts|nonce|ua)
# 过期： 1800 秒；未来 300 秒以内视为有效（允许时钟误差）
# 绑定： UA（不绑定 IP，避免代理换 IP 造成误伤）
# ============================================
set $sc2_ok 0;

# ============================================
# 受保护的页面（可按需调整前缀）
# ============================================
location ~ ^/(product|shop|category|cart|checkout|account)/ {
    access_by_lua_block {
        if ngx.var.need_challenge ~= "1" then
            return
        end

        local function deny(reason)
            return ngx.exec("@challenge")
        end

        local cookie = ngx.var.http_cookie or ""
        local c = cookie:match("^%s*sc2=([^;]+)") or cookie:match(";%s*sc2=([^;]+)")
        if not c then
            return deny("no_cookie")
        end

        c = c:gsub("^%s+", ""):gsub("%s+$", "")
        c = c:gsub('^"', ""):gsub('"$', "")

        local ts, nonce, mac = c:match("^(%d+)_([0-9a-fA-F]+)_([0-9a-fA-F]+)$")
        if not ts then
            return deny("bad_format")
        end

        if #mac ~= 32 or #nonce < 6 or #nonce > 32 then
            return deny("bad_format")
        end

        ts = tonumber(ts)
        local now = ngx.time()
        if not ts or (now - ts) > 1800 or (ts - now) > 300 then
            return deny("expired")
        end

        local secret = ngx.var.sc_secret or os.getenv("SC_SECRET")
        if not secret or #secret < 16 then
            return deny("no_secret")
        end

        local data = secret .. "|" .. ts .. "|" .. nonce .. "|" .. (ngx.var.http_user_agent or "")
        local expected = ngx.md5(data)
        if expected ~= string.lower(mac) then
            return deny("mac_mismatch")
        end

        ngx.var.need_challenge = "0"
        ngx.var.sc2_ok = "1"
    }
    try_files $uri $uri/ /index.php?$args;
}

# ============================================
# 挑战页：生成签名 Cookie 并刷新
# ============================================
location @challenge {
    internal;
    content_by_lua_block {
        -- 速率限制：同一 IP 60 次/分钟
        local dict = ngx.shared.sc_token_store
        if dict then
            local key = ngx.var.remote_addr or "0"
            local new, err = dict:incr(key, 1, 0, 60)
            if new and new > 60 then
                return ngx.exit(429)
            end
        end

        local secret = ngx.var.sc_secret or os.getenv("SC_SECRET")
        if not secret or #secret < 16 then
            ngx.status = 500
            ngx.say("SC secret missing")
            return
        end

        local now = ngx.time()
        local nonce = string.sub(ngx.md5(now .. ngx.var.request_uri .. (ngx.var.remote_addr or "") .. math.random()), 1, 12)
        local data = secret .. "|" .. now .. "|" .. nonce .. "|" .. (ngx.var.http_user_agent or "")
        local mac = ngx.md5(data)

        local cookie = string.format("sc2=%d_%s_%s; Path=/; HttpOnly; SameSite=Lax; Max-Age=1800", now, nonce, mac)
        local xfproto = (ngx.var.http_x_forwarded_proto or "")
        if xfproto == "https" or ngx.var.scheme == "https" then
            cookie = cookie .. "; Secure"
        end

        ngx.header["Set-Cookie"] = { cookie }
        ngx.header["Content-Type"] = "text/html; charset=utf-8"
        ngx.header["Cache-Control"] = "no-store"
        ngx.header["X-Robots-Tag"] = "noindex"

        local f = io.open("/www/server/nginx/conf/js_challenge_openresty.html", "rb")
        if not f then
            ngx.status = 503
            ngx.say("challenge template missing")
            return
        end
        local body = f:read("*a")
        f:close()
        ngx.say(body)
    }
}
