# /www/server/nginx/conf/com.conf -> /www/sh/nginx_conf/com.conf
# ====é™åˆ¶éæ­£å¸¸å®¢æˆ·æ·»åŠ è´­ç‰©è½¦(æ¶æ„æˆ–è€…ä¸å¿…è¦çš„add-to-cartè¡Œä¸º)====================
# æ£€æŸ¥æ˜¯å¦åŒ…å« add-to-cart æŸ¥è¯¢å‚æ•°åœ¨serverå—ä¸Šä¸‹æ–‡ä¸­,ä¼šè¢«å„locationä¸Šä¸‹æ–‡æ‰€ç»§æ‰¿
# ä¾‹å¦‚googlebotå¯èƒ½ä¼šè®¿é—® "GET /product/.../?add-to-cart=147667 HTTP/1.1"
# å…¶ä»–ä¼ªè£…UAæˆ–äººç±»ç”¨æˆ·çš„çˆ¬è™«æ¯”å¦‚: "GET /?add-to-cart=263827 HTTP/1.1"

# ç»è¿‡æ¨¡æ‹Ÿæµ‹è¯•å’Œåˆæ­¥åˆ†æå¯çŸ¥,æ­£å¸¸ç”¨æˆ·ä¹°äº§å“çš„æ—¥å¿—ä¸­ä»…æœ‰ä¸€æ¡å’Œadd to cartç›¸å…³çš„æ—¥å¿—
# æ ¸å¿ƒè´­ç‰©æ“ä½œ:ç‚¹å‡»æ¨¡æ¿äº§å“å¡ç‰‡æ·»åŠ è´­ç‰©è½¦æŒ‰é’®è§¦å‘:POST /?wc-ajax=add_to_cart (åŸºç¡€è¡Œä¸º),æ ¹æ®ä¸åŒæ¨¡æ¿,
# å¯èƒ½é™„å¸¦POST /wp-admin/admin-ajax.php,GET /?wc-ajax=get_refreshed_fragments ç­‰å…¶ä»–å‰¯æ“ä½œ
# å¦‚æœä»äº§å“è¯¦æƒ…é¡µç‚¹å‡»æ·»åŠ è´­ç‰©è½¦ä¹Ÿä¸ä¼šæœ‰add-to-cartç›¸å…³è®°å½•(æ³¨æ„è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿çš„åŒºåˆ«)
# å¯¹äºadd_to_cartçš„é“¾æ¥å¯ä»¥è€ƒè™‘åšä¸“é—¨çš„é™æµ,è€Œå¯¹add-to-cartåšé™åˆ¶è®¿é—®
# [ç‰¹æ®Šæƒ…å†µadd-to-cart]
# 1.æœ‰äº›æ¨¡æ¿æ²¡æœ‰ä½¿ç”¨ajaxæ·»åŠ è´­ç‰©è½¦,æ¯”å¦‚é¦–é¡µç‚¹å‡»æ·»åŠ è´­ç‰©è½¦,ä¼šè®¿é—®add-to-carté“¾æ¥,è¿™ç§æƒ…å†µä¸‹è€ƒè™‘ä¸ç¦ç”¨add-to-cartè·¯å¾„
# 2.å¤šæ•°æ¨¡æ¿åœ¨é¦–é¡µä¸Šå±•ç¤ºçš„äº§å“å¡ç‰‡ä¸Šçš„å¦‚æœæœ‰è´­ç‰©è½¦æŒ‰é’®,å¹¶ä¸”é¦–é¡µè¿˜ä¹ˆæœ‰æ¥å¾—åŠåŠ è½½å®Œæ¯•,ç”¨æˆ·å°±ç‚¹å‡»äº†æ·»åŠ è´­ç‰©è½¦æŒ‰é’®,ä¹Ÿä¼šè®¿é—®add-to-carté“¾æ¥,
#   ä½†æ˜¯æ­£å¸¸å®¢æˆ·ä¸å¤ªå¯èƒ½è¿™ä¹ˆåš,ä¸€èˆ¬åªä¼šå‘ç”Ÿåœ¨ç½‘ç«™æ£€æŸ¥çš„æ—¶å€™.
# è‡ªå®šä¹‰ç‰¹æ®Šæ—¥å¿—è®°å½•
# ä½¿ç”¨å˜é‡(æ¯”å¦‚$server_name)å¯ä»¥ä¸ºä¸åŒç½‘ç«™äº§ç”Ÿå„è‡ªçš„æ—¥å¿—æ–‡ä»¶,å¦‚æœä¸ºäº†ä½¿ç”¨fail2bané›†ä¸­åˆ†æå¯ç–‘æ¶æ„è¯·æ±‚,åˆ™å¯ä»¥é›†ä¸­åˆ°åŒä¸€ä¸ªå¯ç–‘æ—¥å¿—æ–‡ä»¶ä¸­
access_log /www/wwwlogs/warn.log combined if=$log_warn;
# access_log /www/wwwlogs/$server_name.warn.log combined if=$log_warn;
access_log /www/wwwlogs/all.log main_format_lite ;
access_log /www/wwwlogs/spider.log main_format_lite if=$allow_bot;
# access_log /www/wwwlogs/$server_name.log main_format;

# include /www/server/nginx/conf/com_js_signed.conf; #openrestyæ–¹æ¡ˆ

# åŒ¹é…æ‰€æœ‰æŸ¥è¯¢å‚æ•°ä¸­åŒ…å«"add-to-cart=" å­—ç¬¦ä¸²çš„è¯·æ±‚
# æ–¹æ¡ˆ1:ä½¿ç”¨map(æ€»é…ç½®httpä¸Šä¸‹æ–‡ä¸­å®šä¹‰å˜é‡$has_add_to_cart)+if
if ($has_add_to_cart) {
    return 403;
}
# æ–¹æ¡ˆ2:ç›´æ¥ä½¿ç”¨if
# if ($args ~* "add-to-cart=") {
#     return            403;
# }

# =====åŸºç¡€é™æµ=====================
# å¯¹æ‰€æœ‰äº§å“é¡µç›¸å…³é“¾æ¥é™æµ(ä¸¥æ ¼çº§åˆ«,å¯¹ç”¨æˆ·ä½“éªŒæœ‰ä¸€å®šå½±å“,ä¸€èˆ¬æƒ…å†µä¸‹,å¯¹å¤§å¤šæ•°çˆ¬è™«æœ‰æ˜¾è‘—æ•ˆæœ)
# æ™®é€šäº§å“é™æµğŸˆ

# å¯¹å›¾ç‰‡é™æµ
location ~* ^/wp-content/uploads/.*\.(webp|jpg|png)$ {
    # é’ˆå¯¹å›¾ç‰‡çˆ¬è™«çš„ä¸“ç”¨æ—¥å¿—æ–‡ä»¶(å¯ä¾›é…åˆfail2ban)
    access_log /www/wwwlogs/imgs.log combined;
    # å›¾ç‰‡é™æµ
    limit_req zone=img_limit burst=80 nodelay;
    #                 é™åˆ¶ä¸‹è½½é€Ÿåº¦ä¸º200KB/s
    limit_rate 300k;

    #                 ç¼“å­˜ä¼˜åŒ–
    expires 1y;
    add_header Cache-Control "public, immutable";

    #                 é™æ€æ–‡ä»¶ç›´æ¥è¿”å›(æ£€æŸ¥ $uriï¼ˆè¯·æ±‚è·¯å¾„å¯¹åº”çš„ç‰©ç†æ–‡ä»¶ï¼‰æ˜¯å¦å­˜åœ¨,å­˜åœ¨ç›´æ¥è¿”å›,å¦åˆ™404ï¼›)
    try_files $uri =404;
}


# ===================== ç¦æ­¢è®¿é—®æ•æ„Ÿè·¯å¾„ =====================
# é˜²æ­¢è·¯å¾„éå†å’ŒåŒæ–œæ ç»•è¿‡(å¤šæ–œæ ,ç”±äºæ˜¯æ­£åˆ™åŒ¹é…(åŒ…å«æ£€æŸ¥),æ‰€ä»¥è¶…è¿‡2ä¸ªæ–œæ ä¹Ÿä¼šè¢«å‘½ä¸­,æ— éœ€ä½¿ç”¨//+æˆ–/{2,}åŒ¹é…)
if ($request_uri ~* "//") {
    return 444;
}
# é˜²æ­¢è®¿é—®åŒ…å«æ•æ„Ÿå…³é”®è¯çš„è·¯å¾„
# /wordpress/ è¿™ä¸ªè·¯å¾„éœ€è¦è°¨æ…,éƒ¨åˆ†åå°ç®¡ç†é¡µé¢å¯èƒ½ä¼šè·³è½¬åˆ°åŒ…å«æ­¤å­—ç¬¦ä¸²çš„è·¯å¾„
# "GET /wp-includes/js/tinymce/skins/wordpress/wp-content.css?ver=6.8.1&wp-mce-49110-20201110 HTTP/1.1"
location ~* (wp-login|xmlrpc|wlwmanifest\.xml|SystemConfig|/setup-config\.php) {
    return 444;
    #                 access_log off;
    #                 log_not_found off;
}

# --- ç¦æ­¢è®¿é—® WordPress ç™»å½•é¡µåŠé…ç½®æ–‡ä»¶ ---
# é™åˆ¶ç”¨æˆ·æšä¸¾æ‰«æ,å¯ä»¥é…åˆfail2banä½¿ç”¨
# é™åˆ¶ REST API ç”¨æˆ·æšä¸¾
# ç²—æš´ç¦æ­¢è®¿é—®æˆ–è·³è½¬åˆ°/wp-login.phpï¼Œé…ç½®ä¸å½“çš„è¯éƒ¨åˆ†æƒ…å†µä¼šæ‹¦ä½è‡ªå·±äººï¼Œå¦‚æœ‰ç‰¹æ®Šéœ€è¦ï¼Œå¯ä»¥ä¸´æ—¶å¼€æ”¾
# (é€šå¸¸æ­£ç¡®å®‰è£…å¹¶æ¿€æ´»wps-hide-loginåä¸ä¼šè¢«æ­¤è§„åˆ™æ‹¦æˆªï¼Œè‡ªå·±äººä½¿ç”¨çº¦å®šçš„å…¥å£urlå¯ä»¥ç™»å½•åå°)
# å¦‚æœä¸éœ€è¦ä½¿ç”¨apiå¯ä»¥é™åˆ¶/api/,ä½†æ˜¯ä¸èƒ½ç›´æ¥é™åˆ¶apiå…³é”®è¯,å¦åˆ™ä¸€äº›ç”¨æˆ·æ“ä½œä¼šå—å½±å“,æ¯”å¦‚æŸ¥çœ‹è´­è½¦ä¸­çš„å•†å“(GET /wp-json/wc/store/v1/cart?...)
# æ­¤å¤–/wp-json/ä¹Ÿä¸èƒ½ç›´æ¥é™åˆ¶,å¦åˆ™æœ‰çš„æ¨¡æ¿è´­ç‰©è½¦é¡µé¢æ•°é‡å¢å‡ä¼šå¤±è´¥!(POST /wp-json/wc/store/v1/batch?_locale=site)
# è¿˜æœ‰/wc-api/æœ‰æ—¶è·³è½¬ä¼šç”¨åˆ°

location ~* wp-login|/api/|/\?author=\d+|/wp-json/wp/v\d+/users {
    deny all;
    return 444;
}

location ~* /\.(git|svn|hg|env|ssh|DS_Store) {
    deny all;
    return 444;
}

# --- å±è”½æ•°æ®åº“/å¤‡ä»½æ–‡ä»¶ ---
location ~* /(dump\.sql|backup(\.sql|\.tar\.gz|\.zip|\.bak)?|database(_backup)?\.sql|schema\.rb) {
    deny all;
    return 444;
}

# --- å±è”½é…ç½®/å‡­è¯æ–‡ä»¶ ---
location ~* /(config(\.json|\.ya?ml|\.php|\.xml)?|secrets?\.json|user_secrets\.yml|production\.json|credentials|id_(rsa|ecdsa|ed25519)|server\.key|\.pem) {
    deny all;
    return 444;
}

# --- å±è”½å¼€å‘å·¥å…·é…ç½® ---
location ~* /(\.vscode|\.idea|sftp\.json|docker-compose\.ya?ml|cloud-config\.ya?ml) {
    deny all;
    return 444;
}

# --- å±è”½æ•æ„Ÿè°ƒè¯•æ¥å£ ---
location ~* /(phpinfo\.php|server-status|_vti_pvt/service\.pwd) {
    deny all;
    return 444;
}


# æ‹’ç»é Google/Bing çˆ¬è™«
if ($allow_access_ua = 0) {
    return 444; # ç›´æ¥æ–­å¼€è¿æ¥
}

# ç¦æ­¢googleè®¿é—®æ·»åŠ åˆ°è´­ç‰©è½¦æŒ‰é’®é“¾æ¥
if ($block_googlebot_cart) {
    return 403;
}
# ç¦æ­¢CNç”¨æˆ·è®¿é—®(åœ¨å„ä¸ªvhostæˆ–è€…å…±åŒincludeçš„å…±ç”¨com.confä¸­åŠ å…¥æ­¤æ®µ)
if ($block_cn = 1) {
    return 444;
}
# ä»¥ä¸‹å›½å®¶/è¯­è¨€ç™½åå•ä»…åœ¨ç´§æ€¥æƒ…å†µå¯ç”¨(å¸¸æ€ä¸‹æœ‰å‰¯ä½œç”¨)
# if ($allowed_country = 0){
# ç›´æ¥æ–­è¿
#     return 444;
# æˆ–è€…è¿”å›ä¸€æ®µè‡ªå®šä¹‰æ–‡å­—
#    add_header Content-Type text/plain;
#   return 403 "Access Denied: Country not allowed.";
# }
# if ($allowed_country_lang = 0){
#     return 444;
# }
# å¯¹äºæ— å…³ç´§è¦çš„è¯·æ±‚å¿½ç•¥å…¶æ—¥å¿—(å…¸å‹çš„/favicon.icoç½‘ç«™å›¾æ ‡è¯·æ±‚)
location = /favicon.ico {
    access_log off; # ä¸è®°å½• access log
    log_not_found off; # å³ä½¿æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸è®°å½• error log
    return 204; # è¿”å›ç©ºå“åº”,204 è¡¨ç¤ºè¯·æ±‚æˆåŠŸ,ä½†æ— å†…å®¹

}

