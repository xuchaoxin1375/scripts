
# =====限流=====================
# 对所有产品页相关链接限流(严格级别,对用户体验有一定影响,一般情况下,对大多数爬虫有显著效果)
# 注意,这还依赖于网站后台中设置产品链接的固定格式为 /product/ 开头
# 如果仅仅是产品名,结果产品页可能是/shop/...的格式,这会导致限流失败(或者添加额外的/shop/链接规则)
# 不过/shop/开头的路径链接不一定是产品页,还可能是产品目录页,比如/shop/page/...等分页目录页
# limit_req zone=user_limit burst=5 nodelay;

# 简单规则:^/(product|shop)/ # 这可能会误伤目录页
# 放行shop分页目录页,捕获/shop/...,但是跳过/shop/和非/shop/page/...的路径
# 方案1:连用两个负向前瞻: ^/shop/(?!page/)(?!$) 
# 方案2:括号嵌套: ^/(product/|shop/(?!(page/|$)))
# (?!page/) - 负向前瞻，排除后面是 page/ 的情况
# (?!$) - 负向前瞻，排除 /shop/ 后面是结尾的情况

# 说明：
# - 本文件不再定义 location（否则会与 JS 挑战的 location 抢匹配，导致两者无法同时生效）
# - 用法：在“已命中的 location { } 内部” include 本文件，以叠加限流规则
# - 设计目标：按站点可选启用限流；不影响所有站点强制启用的 JS 挑战

# burst 参数越小，限制越严格（3~5 十分严格，10 一般严格）
limit_req zone=product_limit burst=7 nodelay;
limit_req zone=bot_limit burst=1 nodelay;
# 可选：自定义限流返回状态码
limit_req_status 429;
