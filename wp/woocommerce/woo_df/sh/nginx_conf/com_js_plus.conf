
# /www/server/nginx/conf/com_js_plus.conf
# JavaScript 挑战配置
# 使用方法：在 server 块中 include 此文件
# product/shop/category/cart/checkout/account等常见页面收保护

# ============================================
# 默认需要挑战
# ============================================
set $need_challenge 1;

# ============================================
# Cookie 验证：格式 时间戳_哈希
# ============================================
if ($cookie_sc ~* "^[0-9]{10}_[a-f0-9]{8,32}$") {
    set $need_challenge 0;
}

# ============================================
# 搜索引擎白名单
# ============================================
if ($http_user_agent ~* "(Googlebot|Google-Read-Aloud|Storebot-Google)") {
    set $need_challenge 0;
}
if ($http_user_agent ~* "(Bingbot|BingPreview|msnbot)") {
    set $need_challenge 0;
}
if ($http_user_agent ~* "(YandexBot|DuckDuckBot|Slurp|Applebot)") {
    set $need_challenge 0;
}

# ============================================
# AI 爬虫白名单
# ============================================
if ($http_user_agent ~* "(GPTBot|ChatGPT|anthropic|Claude|PerplexityBot|cohere-ai)") {
    set $need_challenge 0;
}

# ============================================
# 社交媒体爬虫
# ============================================
if ($http_user_agent ~* "(facebookexternalhit|Twitterbot|LinkedInBot|Pinterest|WhatsApp|TelegramBot|Discordbot)") {
    set $need_challenge 0;
}

# ============================================
# 支付/监控服务
# ============================================
if ($http_user_agent ~* "(PayPal|Stripe|Shopify|UptimeRobot|Pingdom)") {
    set $need_challenge 0;
}

# ============================================
# 静态资源跳过验证
# ============================================
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot|mp4|mp3|pdf|zip)$ {
    set $need_challenge 0;
    expires 30d;
    access_log off;
}

# ============================================
# 受保护的页面
# ============================================
location ~ ^/(product|shop|category|cart|checkout|account)/ {
    
    error_page 503 @challenge;
    
    if ($need_challenge = 1) {
        return 503;
    }
    
    try_files $uri $uri/ /index.php?$args;
}

# ============================================
# 挑战页面处理
# ============================================
location @challenge {
    internal;
    root /www/server/nginx/conf;
    add_header Content-Type "text/html; charset=utf-8" always;
    add_header Cache-Control "no-store" always;
    add_header X-Robots-Tag "noindex" always;
    try_files /js_challenge.html =503;
}