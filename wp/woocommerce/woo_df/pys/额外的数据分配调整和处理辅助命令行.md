

[toc]



## 有用的命令行

### 网站间的数据分配调整👺

假设用户在本地建立了4个网站(a.com,b.com,c.com,d.com)

每份分配了7份csv(每份1万来算,共有7万数据),但是某个站的图片下载异常(比如链接失效,或者下载图片都是破图或者压根就打不开或下不动),这种情况下,如果图片异常的数量达到2万以上,意味着这个站(比如a.com)数据将不够

如果其他站(比如b.com)数据比较充裕(下载图片后,数量损失不超过1万),可以考虑将其中的一份csv移动到a.com中调节

移动分为两部分,首先一个是移动图片(这个工程量比较大,如果图片名是按照有序编号sku开头,可以将图片按照名字排序,然后指定区间内sku的图批量选中,剪切到另一个站,再把csv移动到对应到站的csv目录中)

其中移动图片的方案还可以通过命令行方式移动`Move-ItemFromCsvPathFields -Path ... -SourceDir ... -Destination ...`

```bash

#修改配置(图片从哪个站点移动到另一个站点)
$fromDomain = "motormeistershop.com"
$toDomain = "autofunktastisch.com"
$csv = "p44.csv" #修改为要移动的csv文件名
$csvFullPath = "$Desktop\data_output\$fromDomain\$csv"
# 开始处理
$csvfrom = "$Desktop\data_output\$fromDomain\$csv"
$csvdest = "$Desktop\data_output\$toDomain\$csv"
Move-ItemImagesFromCsvPathFields -Path $csvFullPath -UseDomainNamePair $fromDomain, $toDomain  -ImgExtPattern '.webp' -Verbose # -IgnoreExtension

#移动csv
Move-Item $csvfrom $csvdest -V

```

## 其他

### 统计jpg,png图片或非webp图片数

利用find来统计

```bash
find . -type f ! -name "*.webp" | wc -l
```

或者一个不太准确的方法(容易算错)

```bash
ls *png *jpg |wc -l
```



### 删除目录中的非webp文件🎈

powershell中在图片目录下执行:

```powershell
ls -File |?{$_ -notlike '*.webp'}|rm -Verbose

```

利用find删除

```bash
find . -type f ! -name "*.webp" -delete
```



其他方案

bash中删除非webp图片

```bash
shopt -s extglob
rm !(*.webp) 
```

仅删除jpg,png图片

```bash
rm *.jpg *.png
```



### 将jpg,png图片后缀重命名为webp🎈

powershell进入到制定目录(需要被重命名文件所在的目录)下,然后执行以下命令

```powershell
# 标准写法(Rename-Item 位于管道符之后,且-newName的参数是代码块,使用$_.Name获取文件名字符串)
# 其中'\.jpg$'是正则表达式,匹配文件名中的后缀部分(\.是小数点的转义,表示.号本身,作为一个整体,$号表示仅匹配字符串的结尾的情况)
ls -File |Rename-Item -NewName {$_.Name -replace '\.jpg$','.webp' }
```

另一种更加直白的写法

```powershell
ls *.jpg,*.png|%{ rni -Path $_ -NewName ((Split-Path -LeafBase $_).ToString()+".webp") -Verbose}

```

对于第一种写法,可以方便地扩展更多的用法,例如将文件名(内部非边缘)中的`.php`字符串替换为`_php`(wordpress中图片路径包含`.php`时,会被解释为php脚本,导致错误解释,可以按如下方法替换文件名,如果文件名本身就一`.php`结尾,则保留不变)

```powershell
ls -File |Rename-Item -NewName {$_.Name -replace '(\.php)(?!$)','_php' }
```

将图片名中的`%`替换为`_`

```powershell
ls *%*| Rename-Item -NewName { $_.Name -replace '%','_' } -Verbose
```

### 将后缀缺失的文件添加默认后缀.webp

```powershell
Get-ChildItem | Where-Object { $_ -notlike "*.webp" } | ForEach-Object { Rename-Item -Path $_ -NewName ($_.Name + ".webp") -Verbose }

```



### wp-cli相关命令🎈

例如批量操作插件(安装/卸载/更新/禁用/启用,或者管理员账号密码更新)的完整和标准操作,可以利用wp命令行来执行

相关用例另见它文 [sh/Readme@sh](../sh/Readme@sh.md)



### 批量下载gz(sitemap gz)

详见403反采



## 批量运行wp命令行

根据需要稍作修改下面的bash脚本模板即可

```bash
#!/bin/bash


BASE_DIR="/www/wwwroot" #根据需要修改(网站根目录是否有wordpress层也要注意修改)
MAX_JOBS=32 #根据需要修改
job_count=0
# 让root用户下可以借用普通用权限进行安全wp cli操作
wp() {
  	user='www' #修改为你的系统上存在的一个普通用户的名字,比如宝塔用户可以使用www
    echo "[INFO] Executing as user '$user':wp $*"
    sudo -u $user wp "$@"
    local EXIT_CODE=$?
    return $EXIT_CODE
}
for wpdir in $(find "$BASE_DIR" -type d -path "*/wordpress" -maxdepth 3); do
    (
        echo "正在处理: $wpdir"
        cd "$wpdir"
        if [ -f "$wpdir/wp-config.php" ]; then
            # 在下面定义需要执行的wp_cli命令行
            # 禁用 wp-cron
            # sudo -u www  wp config set DISABLE_WP_CRON true --raw --path="$wpdir"

            # 禁用自动更新
            # sudo -u www wp config set AUTOMATIC_UPDATER_DISABLED true --raw
            # sudo -u www wp config set WP_AUTO_UPDATE_CORE false --raw
            
            # 重置astra主题中woocommerce购物车按钮文本(关闭文件自定义使用模板语言的默认值)
            # sudo -u www wp eval '
            # $settings = get_option("astra-settings", array());
            # unset($settings["woo-cart-button-text"]);
            # update_option("astra-settings", $settings);
            # '

            if [ $? -eq 0 ]; then
                echo "  ✅ 成功执行wp命令"
            else
                echo "  ❌ 设置失败，请检查该目录的权限或 WP 安装情况"
            fi
        else
            echo "  ⚠️ 未找到 wp-config.php，跳过"
        fi
    ) &
    job_count=$((job_count+1))
    if [ "$job_count" -ge "$MAX_JOBS" ]; then
        wait
        job_count=0
    fi
done
wait
```

